# v1.7.0 发行说明

## 概述

v1.7.0 是一个里程碑式的版本，带来了全新的域名元数据管理系统和底层架构的重大重构。本版本新增域名收藏、标签、颜色标记和备注功能，大幅提升域名管理效率；同时完成凭证存储的类型安全重构，并优化了 DNS 记录编辑体验。这些改进让 DNS Orchestrator 从单纯的记录管理工具进化为功能完善的域名资产管理平台。

## ⚠️ 重要提示

**本版本包含凭证存储格式的底层重构，首次启动时会自动迁移数据：**

- ✅ 从 v1.6.x 升级到 v1.7.0：完全自动，无需手动操作
- ⚠️ **未来的 v2.0.0 将不支持从 v1.6.x 直接升级**
- 📋 **必须先升级到 v1.7.x，才能升级到 v2.0.x**
- 🔒 迁移过程安全可靠，会自动创建备份

**如果当前使用 v1.6.x，请务必升级到本版本，以确保未来平滑升级到 v2.0.0。**

详细说明请参阅 [升级说明](#升级说明) 章节。

## 新增功能

### ⭐ 域名元数据管理系统

全新的域名自定义元数据功能，支持个性化域名管理和快速定位关键域名：

**核心功能**：
- **收藏域名**：一键标记重要域名，首页快速访问
- **标签管理**：为域名添加自定义标签，支持多标签分类
- **颜色标记**：10 种预设颜色视觉区分域名
- **备注功能**：为域名添加最多 500 字符的备注说明

**批量操作**：
- 批量添加标签（支持中英文逗号分隔）
- 批量移除标签（选择性清理）
- 批量替换标签（快速重分类）
- 批量选择模式（多选域名统一操作）

**智能筛选**：
- 按标签筛选域名（支持多标签"或"逻辑）
- 标签搜索功能（Popover + Command 模式）
- 自动同步失效标签（删除标签后自动清理筛选器）

**用户体验**：
- 收藏域名专属页面（按时间排序、快速跳转）
- 折叠式元数据编辑器（颜色、标签、备注一体化管理）
- 域名列表实时显示标签和颜色标记
- 导航树集成颜色指示器
- DNS 记录页显示备注信息

**技术实现**：
- 四层架构设计（Frontend → Tauri → Service → Repository）
- 元数据持久化到本地存储（Tauri Stronghold）
- 批量加载优化（减少 IPC 调用次数）
- 批量保存优化（两阶段处理：内存计算 + 批量写入）
- 完整的类型安全（Rust + TypeScript）

**输入验证**：
- 标签长度限制（50 字符，实时计数显示）
- 备注长度限制（500 字符）
- 颜色值验证（10 种预设 + "none"）
- 长标签自动截断（悬停显示完整内容）

### 📝 DNS 记录编辑器增强

大幅改进 DNS 记录编辑体验，新增实时提示和智能筛选功能：

**实时记录提示**：
- 根据用户输入动态显示记录的实际作用
- 支持所有记录类型（A/AAAA/MX/CNAME/TXT/NS/SOA 等）
- 可通过设置开关控制显示（默认开启）
- 在示例说明和实时提示之间智能切换

**标签筛选重构**：
- 从 DropdownMenu 升级为 Popover + Command 模式
- 支持标签搜索功能（快速定位）
- 添加筛选逻辑说明（显示包含任一所选标签的域名）
- 优化筛选标签显示样式（悬停效果 + 长标签提示）

**代码质量**：
- 添加 exhaustive checks（新记录类型未处理时抛出错误）
- 提取 `renderRecordHint` 函数（消除重复代码）
- 优化表单布局（提升可读性）

**新增依赖**：
- `@radix-ui/react-popover`：弹出层组件
- `cmdk`：命令面板组件

### ⚙️ 设置页面重构

全新的标签页布局，提升设置管理体验：

**三大标签页**：
- **外观设置**：主题、语言、通知配置
- **功能设置**：DNS 提示、分页模式、操作通知
- **关于页面**：版本信息、更新检查、许可证

**新增功能**：
- 操作通知开关（控制成功/失败提示显示）
- 分页模式设置（使用 RadioGroup 风格）
- 独立的更新检查组件（`UpdateChecker.tsx`）

**用户体验**：
- 设置项按功能域分组（逻辑清晰）
- 多语言支持（中英文完整翻译）
- 保持原有功能不变（仅重构结构和布局）

## 重大重构

### 🔐 凭证存储类型安全重构

完成凭证存储系统的底层重构，从弱类型 HashMap 升级为强类型 ProviderCredentials：

**核心变更**：
- 凭证格式从 `HashMap<String, String>` 重构为类型安全的 `ProviderCredentials` 枚举
- 统一前后端凭证处理逻辑（移除冗余的 `from_map()` 转换）
- CredentialStore trait 方法重命名：
  - `load()` → `get()`
  - `save()` → `set()`
  - `delete()` → `remove()`

**自动迁移**：
- 新增 `MigrationService` 支持 v1.7.0 凭证格式自动升级
- 启动时自动检测旧版本数据并迁移
- 迁移失败账户标记为 Error 状态（便于界面展示）
- 迁移成功后自动清理备份，失败时保留备份供手动恢复

**向后兼容**：
- Tauri 适配器支持双格式读取（兼容旧版本数据）
- 迁移备份逻辑移至 Tauri 层（保持核心层平台无关性）
- 所有相关服务同步更新（AccountLifecycleService、CredentialManagementService 等）

**架构优化**：
- 核心层不再处理文件系统操作（遵循分层原则）
- 凭证备份逻辑从核心迁移服务移至应用层
- 增强错误处理和调试日志

### 📚 文档体系重构

创建完整的结构化文档体系，提升项目可维护性：

**文档结构**：
```
docs/
├── README.md              # 文档导航
├── architecture/          # 架构设计文档
├── development/           # 开发文档
├── guides/                # 用户指南（含升级指南）
├── api/                   # API 参考
├── projects/              # 项目管理文档
│   ├── credentialstore-refactor/  # 凭证存储重构
│   ├── domain-metadata/           # 域名元数据系统
│   └── toolbox/                   # 工具箱扩展
└── i18n/zh-CN/           # 国际化文档
```

**新增文档**：
- **域名元数据系统**：完整的 API 参考、架构设计、实施指南
- **凭证存储重构**：重构方案、实施步骤、清理计划
- **工具箱项目**：已完成功能和计划功能
- **升级指南**：版本升级说明和注意事项

**文档国际化**：
- 支持中英文双语文档
- 核心架构文档已完成中文版本

## 技术改进

### 性能优化

**批量操作优化**：
- 域名元数据批量保存采用两阶段处理（内存计算 + 批量写入）
- 减少存储层写入次数（显著提升批量标签操作性能）
- DomainMetadataRepository trait 新增 `batch_save` 方法

**前端优化**：
- 提取通用批量操作逻辑（消除重复代码）
- 修复 DomainSelectorPage 滚动位置恢复问题（避免不必要的依赖更新）
- 优化域名列表性能（批量加载元数据）

### 代码质量提升

**类型系统**：
- 凭证类型完全类型安全（编译时错误检查）
- 统一前后端类型定义（减少转换代码）
- 元数据类型定义完整（`DomainMetadata`、`DomainMetadataUpdate`）

**代码重构**：
- 提取 domainStore 通用批量操作逻辑（提高可维护性）
- 重构标签筛选组件（拆分为 TagFilterButton 和 SelectedTagsList）
- 优化导入顺序和代码格式（提升一致性）

**架构优化**：
- 新增导航类型定义文件（`src/types/navigation.ts`）
- 统一管理 NavItem 类型和路径映射
- 移除重复的导航路径定义

### 用户界面改进

**新增页面**：
- 收藏域名专属页面（`FavoriteDomainsPage.tsx`）
- 设置三大标签页（AppearanceTab、FeaturesTab、AboutTab）

**新增组件**：
- `DomainMetadataEditor.tsx`：域名元数据编辑器
- `DomainColorPicker.tsx`：颜色选择器
- `DomainFavoriteButton.tsx`：收藏按钮
- `DomainTagList.tsx`：标签列表显示
- `DomainBatchActionBar.tsx`：批量操作工具栏
- `TagFilter.tsx`：标签筛选器
- `UpdateChecker.tsx`：更新检查组件

**UI 库扩展**：
- 新增 `command.tsx`：命令面板组件
- 新增 `popover.tsx`：弹出层组件
- 优化多个现有组件的 Tailwind CSS 类顺序

### 多语言支持

**新增翻译项**：
- 域名元数据相关（89+ 条中英文翻译）
- 设置页面重构相关（标签页标题、功能说明）
- DNS 记录提示相关（记录实时提示文本）
- 批量操作相关（成功/失败提示）

## 技术统计

- **新增文件**：约 50 个
  - Rust 核心模块：7 个（domain_metadata_service.rs、migration_service.rs、domain_metadata_repository.rs 等）
  - React 组件：15 个（域名元数据相关组件、设置标签页等）
  - 类型定义：4 个（domain_metadata.ts、navigation.ts 等）
  - 文档文件：24+ 个

- **修改文件**：约 67 个
- **新增代码**：+10,593 行
- **删除代码**：-1,025 行
- **净增加**：+9,568 行

**依赖变更**：
- 新增前端：`@radix-ui/react-popover`、`cmdk`
- Rust 依赖无变更（复用现有技术栈）

## 升级说明

从 v1.6.0 升级到 v1.7.0 需注意以下事项：

### ⚠️ 凭证自动迁移（重要）

**v1.7.0 进行了凭证存储格式的底层重构，首次启动时会自动迁移数据。**

1. **自动迁移流程**
   - 启动应用时会自动检测旧版凭证格式（v1.6.x）
   - 迁移过程完全自动化，通常在 1-2 秒内完成
   - 迁移成功后会自动清理备份文件
   - 迁移失败的账户会标记为 Error 状态，不影响其他账户

2. **迁移失败处理**
   - 如果发现账户状态为 Error，说明该账户凭证迁移失败
   - 备份文件保留在应用数据目录：
     - macOS: `~/Library/Application Support/com.apts1547.dns-orchestrator/`
     - Windows: `%APPDATA%\com.apts1547.dns-orchestrator\`
     - Linux: `~/.local/share/com.apts1547.dns-orchestrator/`
   - **建议操作**：删除失败的账户，重新添加凭证

3. **数据安全保障**
   - 所有凭证仍存储在系统钥匙串/Stronghold 中（存储位置未变）
   - 仅数据格式升级：`HashMap<String, String>` → `ProviderCredentials` 枚举
   - 迁移前会自动创建备份，失败时可手动回滚

4. **未来升级路径（重要）**
   - v1.7.0 是过渡版本，提供完整的兼容性支持
   - **未来的 v2.0.0 将移除迁移代码，不支持从 v1.6.x 直接升级**
   - 如果当前使用 v1.6.x，**必须先升级到 v1.7.x，再升级到 v2.0.x**
   - 正确升级路径：`v1.6.x → v1.7.x → v2.0.x`

### 新功能说明

1. **域名元数据**
   - 默认所有域名无元数据（收藏、标签、颜色、备注均为空）
   - 可在域名列表页或 DNS 记录页添加元数据
   - 元数据存储在本地，不会同步到 DNS 服务商

2. **设置页面**
   - 设置项已重新组织为三大标签页
   - 所有原有设置保持不变，仅布局调整
   - 新增"操作通知"开关控制成功/失败提示

3. **DNS 记录提示**
   - 默认开启实时记录提示
   - 可在"设置 → 功能"中关闭

**破坏性变更**：

1. **凭证存储数据格式变更**
   - 数据格式从 `HashMap<String, HashMap<String, String>>` 升级为 `HashMap<String, ProviderCredentials>`
   - v1.7.0 提供自动迁移，从 v1.6.x 升级无感知
   - **重要**：未来的 v2.0.0 将移除兼容代码，**不支持**从 v1.6.x 直接跳跃升级到 v2.0.x
   - 升级路径：`v1.6.x → v1.7.x → v2.0.x` ✅  |  `v1.6.x → v2.0.x` ❌

2. **CredentialStore Trait API 变更**（仅影响外部调用者）
   - 方法重命名：`load()` → `get()`, `save()` → `set()`, `delete()` → `remove()`
   - 如果有外部工具或插件直接使用 CredentialStore trait，需要更新方法调用
   - 普通用户不受影响

3. **前端类型定义变更**（仅影响开发者）
   - `CreateAccountRequest.credentials` 从 `Record<string, string>` 改为结构化的 `ProviderCredentials` 联合类型
   - 如果有自定义前端扩展，需要更新类型定义

## 已知问题

- 批量标签操作时，如果域名数量过多（1000+）可能需要较长处理时间
- 标签筛选暂不支持"与"逻辑（仅支持"或"逻辑，即显示包含任一所选标签的域名）
- 域名颜色标记在深色模式下的对比度可能需要进一步优化

## 致谢

感谢以下开源项目：
- `@radix-ui/react-popover`：无障碍的弹出层组件
- `cmdk`：强大的命令面板组件
- Tauri 团队：持续改进跨平台框架

## 下一步计划

- 支持域名元数据导出/导入（JSON/CSV）
- 增强标签筛选（支持"与"逻辑、正则表达式）
- 域名分组功能（基于标签的虚拟分组）
- 更多网络工具（Ping、Traceroute、端口扫描）
- 工具箱结果导出功能

---

**完整变更日志**：[v1.6.0...HEAD](https://github.com/AptS-1547/dns-orchestrator/compare/v1.6.0...HEAD)
